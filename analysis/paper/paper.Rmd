---
title: "Assessing the impact of urban heating on tree growth in Berlin with open inventory and environmental data"
author:
  - Alexander G. Hurley$^{a *}$, Ingo Heinrich$^{a,b,c}$ \\
  - $^a$ *Geoforschungszentrum Potsdam, Climate Dynamics and Landscape Evolution, Potsdam, Germany*
  - $^b$ *Deutsches Archäologisches Institut, Dendroclimatology, Berlin, Germany*
  - $^c$ *Geography Department, Humboldt-Universität zu Berlin, Berlin, Germany*
  - "* Corresponding author: hurley@gfz-potsdam.de"
date: "`r format(Sys.time(), '%d %B, %Y')`"
always_allow_html: true
output: 
    bookdown::html_document2:
      fig_caption: yes
      toc: false
      number_sections: false
      global_numbering: true
    bookdown::word_document2:
      number_sections: false
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
      global_numbering: true
    bookdown::pdf_document2:
      fig_caption: yes
      toc: yes
      number_sections: false
      global_numbering: true
header-includes:
- \usepackage{amsmath}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage[normalem]{ulem}

bibliography: 
  - uhi_references.bib
  - 04_gfz_UHI.bib
  - 07_phenoTram.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  **Abstract** The socio-ecological benefits that urban trees provide depend on their health and performance. Excess heat (i.e., Urban Heat Island; UHI) and other urban conditions affect tree physiology with outcomes from enhanced growth to mortality. Resilient urban forests in the face of climate change require species-specific understanding of growth responses. However, to date, studies assessing growth dynamics were primarily based on remote sensing of communities rather than individuals, or relied on labor-intensive methods that can limit the spatial coverage necessary to account for highly variable urban growing conditions. Here, we analyze growth dynamics of common urban tree species over time and across space for Berlin (Germany), a large metropolis, combining dendroecological (temporal) and inventory assessments (spatial). First, we show that annual increments increased across the 20th century for early (i.e., young) growth. Second, we use an approach relying on open inventory data to identify growth potential (diameter) in relation to excess heat across Berlin while accounting for age, potential management effects, and the urban fabric (e.g., planting area; building density, height; available soil nutrients) by applying generalized additive models for the ten most abundant species. Our analyses showed that younger trees may benefit from increased temperatures, while older individuals feature lower growth at greater UHI magnitudes. Furthermore, we show that planting area as well as building density modulate growth responses to temperature. Lastly, we discuss implications for the management of urban trees in the context of climate change mitigation, considering that younger trees are predominantly located at UHI “hot spots” and will undergo the observed age-dependent shift in temperature-growth sensitivity. By relying on increasingly available open data (inventories, urban/environmental data) our approach here is or will be readily transferable to other urban regions, allowing for species-specific growth assessments, while accounting for urban conditions at an individual level.
  
keywords: |
  Uferbaeume; Anlagenbaeume; Strassenbaeume; 
highlights: |
  We will see. 
---

<style>
body {
text-align: justify}
</style>

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r setup, echo = FALSE, cache = FALSE, include = FALSE}
knitr::opts_knit$set(root.dir = here::here(),
                     base.dir = here::here())

knitr::opts_chunk$set(
  fig.align = "center",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  # fig.path = "../figures/",
  fig.path = paste0(file.path(here::here(), "analysis", "figures"), "/"),
  dpi = 300
)


out_format <- knitr::opts_knit$get("rmarkdown.pandoc.to")

pgbreak <- function() {
  if (grepl("docx", out_format)) {
    return("##### pagebreak")
  } else if (knitr::is_latex_output()) {
    return("\\newpage")
  }
}


library(drake)
library(kableExtra)
# library(ggplot2)
# library(patchwork)
```

`r pgbreak()`

# Introduction {#sec:intro}

<!-- The manifold ecological and societal benefits urban trees provide [e.g., @roy2012] depend on their health and performance.  -->
<!-- For instance, trees alter local energy budgets [@grimmond1996 ; @hertel2019] through shading and transpiration [@gillner2015;@endlicher2016], and therefore can reduce ambient temperatures, infrastructure power-consumption and (human) thermal discomfort  [e.g. @gulyas2006; @akbari2001; @mayer1987; @hoyano1988]. -->
<!-- However,  -->
Excess heat common for cities [i.e., Urban Heat Island, UHI, @oke1982], combined with other urban conditions, affects tree physiological functioning with outcomes ranging from enhanced growth to early senescence, branch die-back, and even mortality [e.g., @hilbert2019;@au2018;@gillner2014]. 
Thus, assessing the effect of increased temperatures on trees, as part of urban green infrastructure, is instrumental for understanding as well as adapting to current and expected conditions in this century [@ward2007], especially considering ever more urbanized societies  and the potential for UHI effects to compound with more frequent atmospheric drought [@roloff2009;@brune2016;@norton2015].


The UHI effect, i.e., the difference between urban and adjacent rural (air) temperatures, has been intensively studied for several decades [cf. @oke1982;@stewart2011].
It is typically related to the structure and density of urban land-use [@kuttler2015], which can be characterized through local climate zones, and modulated by physiographic and urban characteristics, such as vicinity to water bodies, predominant wind and street direction, etc. [@stewart2012]; yet, the physical basis for the excess heat in cities is to a large extent found in the altered surface energy balance as the proportional cover of vegetation decreases compared to rural (or reference) systems [@hertel2019; @oke1992].
In temperate climates, this results in strongest UHI magnitudes at night [cf. @fenner2014].
For example, Berlin features the most intense UHI in Germany due to its large extent and development intensity  with an average air temperature increase of around 5 K at night-times (2001-2010) with maxima of up to 11 K [@fenner2014] in urban $vs.$ rural areas.

Increased air temperatures due to UHIs can affect tree growth through altering several physiological processes across plant organs directly or indirectly [@dusenge2019].
Generally, reaction times at cellular level increase with temperature up to a maximum, after which a drop in enzymatic activity results in a species-dependent optimum curve  [@arcus2016; @parent2010]. 
In leaves this optimum response is reflected in the net assimilation rate of carbohydrates, as a balance of photosynthesis and respiration, with losses exceeding gains more rapidly with increasing temperatures [@long1991].
These responses vary between species [@tjoelker2001] as well as intra-specifically due to local acclimation, i.e., a shift of optimum temperature responses after prolonged exposure [@yamori2014], and threshold temperatures before tissue damage occurs [for review see @geange2021].
High temperatures in temperate areas are often coincident with low relative air humidity (i.e., large vapor pressure deficit), which in turn can decrease stomatal conductance governing the majority of gas exchange in leaves [@grossiord2020], and thus the capacity for photosynthesis.
Under prolonged stomatal closure (or decreased conductance) with high temperatures, trees may thus face decreased growth (in subsequent years) or even starvation as their carbohydrate reserves are depleted yet not replenished at sufficient rates [@mcdowell2008].
Furthermore, air (and soil temperatures) affect the initiation, speed and cessation of cambial activity, and thus radial growth throughout a growing season [e.g., see @begum2013; @rathgeber2016].
Radial growth is increasingly considered to be limited by wood formation dynamics and their relation with environmental drivers, rather than solely by photosynthetic activity [@korner2015].
In particular, the availability of soil water is critical for cell expansion [e.g., @peters2021a] and most likely limits radial growth before photosynthesis [@fatichi2014]; however, this water availability is again linked to local climate as higher temperatures drive evaporation and thus may contribute to the depletion of soil water storage, impeding growth.

<!-- Higher temperatures lead to more rapid reaction times at cellular level in the cambium , i.e., controlling incremental growth [@begum2013],  and during photosynthesis [@yamori2014], can extend leaf-on phases, and  may be associated with less cloudy conditions, indirectly increasing the availability of energy for photosynthesis. -->
<!-- However, if temperatures exceed photosynthetic optima, productivity may decline rapidly followed by (permanent) tissue damage in leaves. -->
<!-- As warmer air is typically drier, high temperatures can also lead to closure of stomata (major leaf gas exchange pathway) to prevent excessive loss of water to a "demanding" atmosphere.  -->
<!-- Additionally, high temperatures at night can increase respiration rates, leading to increased loss of carbohydrates. -->
<!-- Where high temperatures and dry air are compounded by atmospheric or soil drought, trees thus not only experience decreased growth, but also may face extensive tissue damage and ultimately starvation. -->
<!-- 	- Compounded by decreased Precip in cities?! Moser reischl? -->


Several urban tree species have been shown to have tendencies of enhanced growth rates and/or productivity compared to rural conspecifics [e.g., @briber2015; @obrien2012], which is typically attributed to increased temperatures [@jia2018; @pretzsch2017], however, a broad range of effect sizes and signs (i.e., reduced growth) specific to species and location are also commonly reported alongside [e.g., @berland2020].
For instance, @zhao2016 showed that productivity rates, as a proxy for growth, increased within urban clusters as urbanization intensifies using remotely sensed vegetation indices.
Furthermore, @moser-reischl2019a identified positive associations between air temperature and radial growth for two species commonly selected by urban planners (*Tilia  cordata* MilL., *Rubinia pseudoacacia*) in Munich.
<!-- [@briber2015; @obrien2012] … generally increased growth -->
<!-- Contrastingly,  @gillner2014 highlight decreased growth for *Acer* species  (*A. platanoides* and *pseudoplatanus*), *Platanus x hispanica* and *Quercus rubra* with higher summer temperatures of the preceding year, especially when compounded with drought, in another major German city (Dresden).  -->
<!-- @quigley2004 identified absolute growth potential decreased for species between rural and urban conspecifics, yet assessments were -->
<!-- <!-- lacked spatially-explicit effect size estimates across the urban-rural space and  --> 
<!-- limited to comparatively small sample sizes per group ($n_{total}~=~230$ divided in 15 species, 3 groups and 2 locations). -->
<!-- @pretzsch2017 inferred enhanced growth in recent decades and across urban locations spanning several latitudes, including Berlin - however, only 145 individuals of one species (*T. cordata*) were assessed there. -->
<!-- As mentioned previously, climate-growth relationships can vary substantially between species, and in fact, @quigley2004 and @pretzsch2017 report contrasting results regarding average tree diameter, i.e. smaller or larger for urban $vs.$ rural trees of same age. -->
Similarly, for Berlin, @dahlhausen2018, identified enhanced growth in highly urbanized environments for *T. cordata*, the most abundant tree of the city, which they attributed to the UHI effect, while intermediate development intensity was adverse for tree growth.
By contrast,  @gillner2014 highlight decreased growth for *Acer* species  (*A. platanoides* and *pseudoplatanus*), *Platanus x hispanica* and *Quercus rubra* with higher summer temperatures of the preceding year, especially when compounded with drought, in another major German city (Dresden). 
These differences in growth trends may result from contrasting species-specific responses to increased temperatures, but are indeed affected by other (time-varying) factors and stochastic processes, such as water availability, pollution and road-salt loading, structural impedance by infrastructure, or management, etc. [@rhoades1999; @quigley2004; @randrup2001; @pauleit2002].
<!-- The potential for (predictable) variability in responses is a strong indication that assessments ought to be done specifically for a given urban area. -->
<!-- , because well-understood tree characteristics [e.g., see @brune2016;@roloff2009] could be strongly - but predictably - modulated by management and/or other environmental controls; for example, if drought hardiness is related to extensive root networks, restricted soil volumes available to street trees will render a species more vulnerable to water stress.  -->
<!-- Further, the variability in responses may require that assessments are developed for a specific region, because well-understood tree characteristics [e.g., see @brune2016;@roloff2009], could be strongly modulated predictably due to management, planting practices, or other environmental controls; for example, if drought hardiness is related to extensive root networks, restricted soil volumes available to street trees will render a species more vulnerable to water stress.  -->
<!-- **expand on location-specific factors that can affect growth** -->

<!-- This can hinder the extrapolation from individual sampling sites toward predicting effect across entire urban areas and tree stocks, especially where studies rely on labor-intensive methods which are limited logistically by sampling effort, reducing sample sizes, and species as well as spatial coverage. -->
<!-- This is exacerbated by a lack of co-located environmental variables (i.e. measured in situ) at pertinent spatial scales, for instance, as noted by @wohlfahrt2019 for air temperature and tree leaf phenology, which may lead to incorrect inferences and interpretations for the role of climate change on growth/productivity when applying space-for-time substitutions. -->
<!-- Space-for-time substitutions and time series comparisons between and within locations are a common approach (cf. studies above) to generate inferences in observational (rather than treatment-control) studies, where manipulations are costly or logistically unfeasible due to time and/or financial constraints. -->
<!-- However, they require  accounting for confounding factors specific to trees' environments, such as street characteristics, development intensity, available soil volume, etc. -->
<!-- While several of the aforementioned studies applied these approaches to quantify temperature and excess heat on growth, they typically compare trees grouped using qualitative or summary descriptors of sampling sites, disregarding the spatio-temporal variability in location-specific factors noted above. -->
Multiple of the aforementioned studies applied space-for-time substitutions or time series comparisons to quantify temperature and excess heat on growth for a given region.
However, they typically compared trees grouped using qualitative or summary descriptors of sampling sites, disregarding the spatial and/or temporal variability in location-specific factors noted above.
This can hinder the extrapolation from individual sampling sites toward predicting effects across entire urban areas and tree stocks, especially when studies rely on labor-intensive methods, 
<!-- which are limited logistically by sampling effort,  -->
reducing sample sizes and coverage of species and space.
A lack of co-located environmental variables (i.e. measured *in situ*) at pertinent spatial scales can further exacerbate these limitations, for instance, as noted by @wohlfahrt2019 for air temperature and tree leaf phenology, which may lead to incorrect inferences and interpretations for the role of climate change on growth/productivity.
It is thus likely that the varying and even contrasting growth responses observed for urban trees across and within studies are at least modulated by some confounding factors, making the attribution to a single driver, such as excess heat, more difficult and possibly less accurate.



These limitations could be overcome by developing extensive dendroecological surveys (i.e., incremental growth) and/or inventories (single or repeat) combined with pertinent environmental data with adequate spatio-temporal coverage and resolution. 
Inventories are logistically and financially more feasible, and - together with environmental data - are increasingly more available [e.g. @ossola2020] due to open data policies and their value being recognized across domains for urban greenspace planning and adaptation [@hansen2019; @monteiro2020].
Berlin, as one of the greenest cities in Europe, provides an openly accessible tree inventory, with spatio-temporal environmental data sets relevant to tree growth. 
It features nearly 700000 individuals covering 94 genera and some 600 species and/or cultivars, listing information on location, stem diameter (at breast height; $DBH$), and stem height, among other variables, for the majority of street and park trees.
For this study, our objective was to assess the impact of excess urban heat, i.e. the UHI effect, on tree growth ($DBH$) using this openly available inventory data set, complemented by additional open data sources as well as incremental growth data from tree cores. 
The assessment relied on flexible statistical models that could capture species and location-specific responses to heat and other urban factors.
Specifically, we aimed to (1) assess heat exposure of the most abundant species; (2) determine the impact of (excess) heat on stem growth across tree age classes with a space-for-time substitution; (3) highlight the role of location-specific environmental factors in mediating temperature responses.
<!-- This work constitutes a case study for Berlin, the results are a valuable contribution toward Berlin's current and future management of its tree stock.  -->
<!-- Our results are a contribution toward Berlin's current and future management of its tree stock and may help drive adaptation to climate change. -->
<!-- Despite being a case study for a single city, we believe our work may provide a flexible approach for other cities with available or growing inventories, as well as ancillary environmental data, and may also inform the use of other planning tools, such as species-climate matrices [@roloff2009] regarding temperature sensitivity.  -->
<!-- This is because the high temporal and spatial variability of controls on growth, and thus variability in responses, require that assessments are developed for a specific region, because well-understood tree characteristics [e.g., see @brune2016;@roloff2009], could be strongly modulated  in predicable ways at a given location or time due to management, planting practices, or other environmental controls; for example, if drought hardiness is related to extensive root networks, small soil volumes available to street trees could render a species vulnerable to water stress.  -->
<!-- As such, the approach can also serve as a framework for base-line assessments for other cities with available or growing inventory and ancillary data [cite something on tree diversity in tree stocks, management, etc.], and also inform species-climate matrices regarding temperature sensitivity -->
<!-- Berlin features the most intense Urban Heat Island (UHI) in Germany due to its large extent and development intensity [@kuttler2015], with temperature increases of up to $12~K$ during day-time and $6~K$ on average for night-times [2001-2010, @fenner2014] in urban $vs.$ rural areas. -->
<!-- Consequently, urban green (infrastructure) systems are subjected to increased heat more frequently, potentially affecting their process dynamics - either positively or adversely.  -->
<!-- Their performance and health, however, is closely tied to local energy budgets [@grimmond1996 ; @hertel2019], which in turn are decisive for controlling human wellbeing [e.g. @maras2016], amongst other factors. -->
<!-- Assessing the effect of increased temperatures on green infrastructure, as part of the urban landscape, is therefore instrumental for understanding, and ultimately mitigating, the potential impact of future warming on increasingly urban societies [@norton2015].  -->
<!-- Trees, in particular, provide shading as well as transpirative cooling in their vicinity [@gillner2015;@oke1982;@endlicher2016], and therefore can reduce ambient temperatures, infrastructure power-consumption and (human) thermal discomfort  [e.g. @gulyas2006; @akbari2001; @mayer1987; @hoyano1988]; -->
<!-- simultaneously, they provide numerous other environmental, cultural and psychological services and/or benefits [see @tzoulas2007 for review]. -->
<!-- Further, recent tree growth dynamics as a proxy for on-going and future warming may provide an additional line of evidence to support the growing knowledge base on future climate-vegetation dynamics [@zhao2016] and may aid in mitigation and adaptation efforts [@pretzsch2017;@brune2016]. -->
<!-- Trees and green infrastructure in urban areas show a tendency for enhanced growth rates and/or productivity compared to rural counterparts [@jia2018; @pretzsch2017], yet feature a broad range of effect size ranges and, in some cases, signs specific to species and locality. -->
<!-- @zhao2016 showed that growth rates increased within urban clusters as urbanization intensifies using remotely sensed vegetation indices. -->
<!-- Similarly, for Berlin, @dahlhausen2018, identified positive growth modulation in highly urbanized environments (using growth increments) for *Tilia cordata* Mill, the most abundant tree of the city, which they attributed to the UHI effect, while intermediate development intensity showed indications of being least favorable for tree growth. -->
<!--  For Berlin, @dahlhausen2018, showed divergent patterns for young and old trees dependent on urban development intensity for *Tilia cordata* Mill, the most abundant tree of the city, but overall reported an increased growth rate which they attributed to the UHI effect. -->
<!-- Further, @moser-reischl2019a identified positive associations between air temperature and radial growth for two species commonly selected by urban planners (*T. cordata*, *Rubinia pseudoacacia*) in Munich. -->
<!-- By contrast, @gillner2014 highlight decreased growth for *Acer* species  (*A. platanoides* and *pseudoplatanus*), *Platanus x hispanica* and *Quercus rubra* with higher summer temperatures of the preceding year, especially when compounded with drought, in another German metropolis (Dresden).  -->
<!-- Differences in growth trends may result from contrasting species-specific characteristics, but are indeed affected by other processes and factors, such as water availability, pollution and road-salt loading, structural impedance through infrastructure or management, etc. [@rhoades1999; @quigley2004; @randrup2001; @pauleit2002]. -->
<!-- Under climate change, atmospheric drought will likely be compounded with high temperatures - and intensified UHIs - more frequently, adding further stress to current urban disturbance regimes [@roloff2009]. -->
<!-- Conditions affecting tree growth can vary greatly within urban areas or regions, and need to be accounted for when establishing relationships with pertinent drivers, such as the UHI effect. -->
<!-- This typically complicates the extrapolation from individual sampling sites toward predicting effect sizes across entire urban areas and tree stocks. -->
<!-- This is especially the case for studies reliant on labour-intensive methods which are limited logistically by sampling effort, reducing sample sizes, as well as species and spatial coverage. -->
<!-- While multiple (locally) important species have been assessed along urban and UHI gradients reflecting a range of conditions, studies reliant on labour-intensive methods are limited logistically by sampling effort, reducing sample size and coverage (i.e. genera and/or species, and space). -->
<!--  However, urban tree growth in urban settings is affected by various processes, which  --> 
<!--  However, growth in urban settings is affected by other processes and factors, such as water availability, pollution and road-salt loading, structural impedance through infrastructure or management, etc. [@rhoades1999; @quigley2004; @randrup2001; @pauleit2002]. --> 
<!-- While multiple (locally) important species have been assessed along urban and UHI gradients reflecting a range of conditions, studies reliant on labour-intensive methods are limited logistically by sampling effort, reducing sample size and coverage (i.e. genera and/or species, and space). --> 
<!-- This typically hinders the extrapolation from individual sampling sites toward prediction of effect sizes across entire urban areas and tree stocks.  --> 
<!--  Therefore, studies reliant on labor-intensive sampling, must carefully address confounding factors to ensure effect sizes are estimated adequately. -->


<!--  Detailed, but spatially-limited dendroecological analyses of climate-growth relationships in Berlin for key species can be enhanced by inferring growth modulation from a large data set in excess of 650000 individuals provided by the Berlin Senate Administration (Senatsverwaltung). -->

<!-- To complement (existing) detailed dendroecological analyses of climate-growth relationships in Berlin for key species, we propose inferring growth modulation from a large data set in excess of 650000 individuals covering 94 genera and at least 600 species and/or cultivars provided by the Berlin Senate Administration (Senatsverwaltung). -->
<!-- This data set contains information on location, species, trunk diameter (at breast height; $DBH$; see Tab.$~$\@ref(tab:tab-tree-overview)), and height, amongst other variables for the majority of street and park trees. -->


```{r tab-tree-overview, eval = FALSE, include = FALSE}
drake::loadd(overview_table)


caption_ov <- "Available records by category in entire data set (n), and those with age and $DBH$ entries (n$_{full}$)."
caption_ov_short <- "Available records in Berlin tree database."


if (grepl("docx", out_format) ||
    knitr::is_latex_output() ) {
  table_ov <- overview_table %>% 
  knitr::kable(booktabs = TRUE,
              
             caption = caption_ov,
             caption.short = caption_ov_short,
             format = "latex",
             # col.names = c("Subject/Relevance",
             #              "Desc.",
             #              "Type",
             #              "Obsv. (n)",
             #              "Resolution (m)",
             #              "Source")
             escape = FALSE) 
  
} else {
table_ov <- overview_table %>% 
  knitr::kable(booktabs = TRUE,
               format = "html",
               
             caption = caption_ov,
             caption.short = caption_ov_short,
             # col.names = c("Subject/Relevance",
             #              "Desc.",
             #              "Type",
             #              "Obsv. (n)",
             #              "Resolution (m)",
             #              "Source")
             escape = FALSE) 
}


 table_ov %>% 
  kableExtra::kable_styling(full_width = TRUE, 
                            font_size = 11,
                            latex_options = c("hold_position")) %>% 
  kableExtra::row_spec(0, bold = TRUE, font_size = 12) 

```

<!-- In a space-for-time substitution, growth of individual species can be assessed across the entire city of Berlin, and related to effects of the UHI, while accounting for other location-specific factors, such as street characteristics, development intensity, available soil volume, etc. -->
<!-- Comparable applications are found, for example, in @quigley2004 and @pretzsch2017. -->
<!-- The former  inferred absolute growth potential for species across successional groups (early, mid, late stage), and between rural and urban conspecifics, yet lacked spatially-explicit effect size estimates across the urban-rural space and was limited to comparatively small sample sizes per group ($n_{total}~=~230$ divided in 15 species, 3 groups and 2 locations). -->
<!-- @pretzsch2017 applied linear hierarchical models to infer growth modulation on annual basis for different time periods and urban $vs.$ rural locations while accounting for stand-level variability; -->
<!-- however, for Berlin only 145 individuals of one species (*T. cordata*) were assessed. -->
<!-- As mentioned previously, climate-growth relationships can vary substantially between species, and in fact, @quigley2004 and @pretzsch2017 report contrasting results regarding average tree diameter, i.e. smaller or larger for urban $vs.$ rural trees of same age. -->
<!-- Consequently, this variability of effect sizes and directions calls for a more comprehensive assessment across species and with greater spatial coverage throughout Berlin. -->

<!-- **We therefore propose applying a statistical model that is fully spatially explicit, while also allowing to account for the nested nature of the data set (e.g. streets and districts) as well as other pertinent factors using hierarchical, generalized additive models (see Section$~$\@ref(sec:methods)). -->
<!-- As a result, the absolute growth potential of a species can be inferred given, for example, a specific location, age or UHI magnitude.  -->
<!-- Further, the impact of UHI loading can be predicted for a single species across all of Berlin as a continuous surface.** -->
<!-- The inclusion of independent, tree-level growth data, however, is paramount as it allows:   -->
<!-- 1) validating the publicly-available Senate data set ($DBH$) while providing a more reliable estimate of tree age,   -->
<!-- 2) applying the model with annual basal area as a response (enabling incorporating effects of varying climate/UHI intensities over time), and   -->
<!-- 3) comparing $DBH$ (Senate data) and basal area-derived models for a subset of locations and species, increasing confidence in Berlin-wide predictions.  -->
<!-- We acknolwedge results from [@gregg2003], which indicated impeded growth adjacent to intense urban clusters, rather than enhancement within them. -->


# Methods {#sec:methods}

## Study area

Berlin is one of the largest metropolitan areas in Central Europe (892$~km^2$) with a population of approximately 3.6 million, and a maximum extent of 38$~km$ in North-South and 45$~km$ in East-West directions. 
It is located in North-Eastern Germany, and lies in the temperate zone with warm-humid climate (Dfb) according to the updated Köppen-Geiger classification [@beck2018], with mean annual temperature of approximately 10$^\circ C$ and precipitation of 575$~mm$ (Tempelhof weather station, DWD).
Berlin features low relief (approximately 30$~m$ to 60$~m$ with 120$~m$ at solitary peaks), and is centered around a glacial outwash valley (sands, gravel), bordered by two plateaus consisting of glacial till and clay in the North-East and South, as well as sands in the South-West.
The city provides extensive public green space covering around 30$~\%$ of its area [@suvkberlin2019], with an extensive urban forest of nearly 700000 publicly-managed trees along streets, in parks and in riparian areas.
<!-- It has a pronounced urban heat island, owing to its high degree of built-up and sealed surfaces, with air temperatures up to 12$^\circ C$ higher in urban compared to adjacent rural areas [@fenner2014]. -->


**Fig. \@ref(fig:fig-study-area) **


<!-- ## General approach: space-for-time analyses -->

<!-- <!-- Species-specifc growth responses in relation across Berlin were assessed in relat --> 
<!-- We modeled the stem diameter ($DBH$) of Berlin’s ten most abundant species (contingent to ancillary data availability) in relationship to their location, age, a measure of (excess) heat [UrbClim by @deridder2015; Berlin Environmental Atlas models; MODIS-derived surface urban heat island by @chakraborty2019], and additional environmental covariates with generalized additive models (GAMs, see Section$~$\@ref(sec:stat-gam) for details). -->
<!-- Covariates were extracted at 150 and 300$~m$ to infer the impact of reference scale of the urban fabric on tree growth.  -->
<!-- From all tested models the most suitable (i.e., parsimonious with highest explanatory) was employed for further analyses. -->


## Data sources {#sec:dsources}

<!-- Berlin’s open data provided tree inventories (species, age, location, diameter which were processed with a bespoke software datacleanr by Hurley et al., submitted), planting bed area, estimates of soil nutrient availability, and adjacent building height. With WUDAPT local climate zones (Demuzere et al., 2019), these were used to determine trees’ growing conditions (locally, or within a radius of 150 m / 300 m).  -->

An overview of data used for models, including sources, types, and application, is provided in Table$~$\@ref(tab:tab-dsources), with detailed descriptions in the following subsections.

**Table$~$\@ref(tab:tab-dsources)**


### Street trees  

Berlin’s open data provided tree inventories including species, age, location, and circumference which was transformed into diameter.
Note that only street trees in urban, not rural areas or within green spaces, were considered here, but individual trees may grow along streets adjacent to green spaces and parks of varying sizes.
Implausible observations, possibly from erroneous data entry, were removed.
Additional manual data processing for quality control was done with a bespoke software  `datacleanr` by [@hurley2022], where obvious outliers or clearly interpolated data were removed.
The latter was deemed necessary, as several observations in multiple city districts were derived by linear relationships (i.e., straight-line), which do not capture the ontogenic growth dynamics of trees, and leave no variation related to variables other than age.
All of these operations were recorded, and can be viewed and reproduced via the code linked in the supplementary material S1.
Lastly, observations with unlikely diameter-age combinations were identified via the residuals of a generalized linear model between diameter and age with a Gamma log-link distribution: if individual residuals exceeded seven times the median absolute deviation of all residuals, they were removed.
The median absolute deviation (MAD) is comparable to the inter-quartile range, yet more robust to outliers:

\begin{equation}
  MAD = median(\|X_i - median(X)\|) 
  (\#eq:mad)
\end{equation}

Similar cut-off approaches are frequently applied in allometric and trait databases. We considered this approach (i.e., $MAD \cdot 7$) conservative, and necessary given the presence of clearly erroneous data.
The approach and impact thereof are visualized in the supplementary material S1 (Section Data quality control).
<!-- which were processed with the bespoke software datacleanr by Hurley et al., submitted), -->
<!-- Characteristics of street trees and their respective environments were collated from the city's tree inventory, as well as various elements of the Berlin Environment Atlas, which are openly available via https://daten.berlin.de and curated by the city's government. -->
<!-- The data used from the inventory includes species, location, age, and diameter at breast height (dbh). -->
Table$~$\@ref(tab:tab-age) shows the binned distribution of genera across age classes.
Final samples applied in models were smaller, following the availability of ancillary data for a given observation, and limited to a maximum age of 125 years to increase confidence in reported values, and ultimately model estimates.

**Table \@ref(tab:tab-age)**

### Temperature/UHI data {#sec:tempdata}

Temperature and UHI data were summarized temporally either by the provider or manually to provide a characteristic representation of heat loading during summer at different times (morning, afternoon/day, night), from which tree averages (radius of 150$~m$) were calculated (Fig.$~$\@ref(fig:fig-temp-overview)).
Two urban air temperature and one surface UHI data set were tested as explanatory variables in generalized additive models (see Section [GAMs](#sec:stat-gam)).
The air temperatures from the Berlin environmental atlas (EnvAt) are processed model outputs [FITNAH-3D; cf. @gross1994] that are representations of typical summer conditions at 0400, 1400 and 2200 hours; these data are provided at city block basis (spatial polygons), from which weighted averages were extracted after rasterizing ($5~m$ resolution).
UrbClim air temperatures are hourly model outputs [100$~m$ resolution, @deridder2015] based on ERA5 re-analyses data (ECMWF) for which observations from the hottest month  available (June, 2011) were averaged to hours equivalent to Berlin Environmental Atlas (referred to as Berlin EnvAt) data by using a window of $\pm~1~$hour (i.e., 0300 to 0500, etc.).
Subsequently, a land-use and land-cover mask (CORINE; European Union, Copernicus Land Monitoring Service 2018, European Environment Agency) was used to define urban and rural/forested areas.
Using this mask was deemed reasonable as Berlin's built-up area has not changed markedly over the past 50 years, i.e., about 52 to 61$\%$ [@mohamed2017]. 
The urban heat loading was then calculated as 

\begin{equation}
 UHI_{x,y} = T_{Air_{2m}~x,y} - \overline{T_{Air_{2m}~Rural}},
  (\#eq:uhi)
\end{equation}

where $T$ is temperature ($^\circ C$) $x$ and $y$ define an urban grid cell.
The MODIS-derived surface UHI data set by @chakraborty2019 (referred to as MODIS) estimates its measure in a similar fashion and the reader is referred to the detailed description therein; note this data set provides day and night-time averaged UHI estimates at 500$~m$ resolution, which were extracted for the hottest summer in this record (2007).

**Fig. \@ref(fig:fig-temp-overview)**


### Ancillary environmental data

Following the general approach described above, four ancillary covariates next to a temperature measure were employed in models; these were chosen due to their availability at high spatial resolution and coverage, and/or because their influence on growth was previously identified in literature or their likely impact could be deduced using ecophysiological principles.
We included planting bed area and the sum of exchangeable basic cation as a proxy for soil nutrient availability (point extractions), as well as the proportional coverage of local climate zone 6 (LCZ6; open mid-rise urban land cover, see @demuzere2019 and @stewart2012 for details) and adjacent building height (rasterized to $5~m$ resolution).
The latter was chosen as an increase reflects a transition away from densely urbanized areas and had the highest coverage (i.e., within [0-1]) for the processed tree inventory.  




<!-- surface area of tree planting beds ("Baumscheibe"), as well as general characteristics of the urban environment like building height. -->
<!-- It also includes spatially-explicit model outputs for local climate simulations representative of typical conditions, such as air temperature (2 m) on a 2015 summer's day at different hours (0400, 1400, 2200).  -->
<!-- These model outputs were preferred over *in situ* measurements as **more representative based on averaged conditions, physiologically more relevant than surface urban heat island products**. -->
<!-- These outputs are available at city block or planning unit level, and were used as a proxy for the general temperature distribution influenced by urbanization across the investigated growth period across the previous 80 years (see section X for details). -->
<!-- This was deemed reasonable as Berlin's built-up area has not changed markedly over the past 50 years, i.e., about 52 to 61$\%$ [@mohamed2017].  -->
<!-- Further insight into the role of the urban environment was assessed by including local climate zone classes derived by WUDAPT. -->
<!-- These describe the proportion of urban area with a specific cover, such as dense high rises, sealed surfaces, etc.  -->
<!-- For this study, the LCZ 6, representing dense mid-rise built up cover was used as a proxy for the degree of urbanization, and is the most frequent LCZ for Berlin [@fenner2017] (found ref in . -->
<!-- Use percent sealed surface instead? -->

## General approach: space-for-time analyses

<!-- Species-specifc growth responses in relation across Berlin were assessed in relat -->
We modeled the stem diameter ($DBH$) of Berlin’s ten most abundant species (contingent to ancillary data availability) in relationship to their location, age, a measure of (excess) heat [UrbClim by @deridder2015; Berlin Environmental Atlas models; MODIS-derived surface urban heat island by @chakraborty2019], and additional environmental covariates with generalized additive models (GAMs, see Section [GAMs](#sec:stat-gam) for details).
Covariates were extracted at 150 and 300$~m$ to infer the impact of reference scale of the urban fabric on tree growth. 
From all tested models the most suitable (i.e., parsimonious with highest explanatory power) was employed for further analyses.


## Dendrochronological sampling {#sec:methods-dendro}

To contextualize tree growth patterns between age groups derived from Berlin's inventory data, we drew upon a recently established data set from [@schneider2021], who sampled several common tree species across a rural-urban gradient. 
For our purposes, we grouped trees sampled in parks, green spaces and along streets into a single urban category, and focused analyses on these.
Two to three cores were extracted at breast height from each tree.
These were then prepared using standard dendro-ecological methods (i.e., mounting, sanding, measuring), and cross-dated with TSAP-Win\textsuperscript{TM} and COFECHA [@holmes1986], producing mean tree series of incremental growth.
Additionally, cambial age of each increment was established by counting years from the inner most ring at the pith ($a = 0$) outward; on tangentially bored cores, missing rings to the pith were estimated.

**Table \@ref(tab:tab-dendro-sites)**


## Statistical Analyses {#sec:stat-gam}

### GAMs

We applied hierarchical generalized additive models (GAM) to estimate the relationship of several covariates with stem diamater growth ($DBH$).
GAMs, as an extension of generalized linear models [@wood2017], allow modeling response variables as parametric and non-parametric combinations of smoothed explanatory covariates, and can assume non-normal response distributions.
These smooths are constructed by summation of base functions of varying complexity and form, analogous to scatterplot smoothing [@hastie2017], which provides a high degree of flexibility, ideal for fitting ecosystem dynamics which are rarely linear [@pedersen2019], or correctly represented with deterministic functional forms (e.g. quadratic equations). 
In general, a GAM can be written as:

\begin{equation}
E (Y)~=~g^{-1}\left( \beta_0 + \sum_{i = 1}^{n} f_i (x_i) \right),
(\#eq:gam-general)
\end{equation}

and

\begin{equation}
y~=~E (Y) + \epsilon,
(\#eq:gam-expectation)
\end{equation}

where $Y$ is taken from an appropriate distribution and corresponding link function $g$, $\beta_0$ is the intercept and $f_i$ represents a smooth function of a predictor [@pedersen2019], and $\epsilon \sim \mathcal{N}(0, \sigma ^2)$. 
Nested data structures (e.g., city districts) can be accounted for by introducing random effects, while spatial dependence between observations can be accounted for by constructing smoothing functions with, for instance, northings and eastings [cf. @wood2017].
All models were implemented in `R` [@rcoreteam2021] using functions available in the package `mgcv` [@wood2017].


### Dendrochronological analyses

We assessed trends in annual growth dynamics of urban trees across the 20$^{th}$ century for 1920-1960 and 1961-2001 [similar grouping as  @pretzsch2017;@dahlhausen2018] with a hierarchical GAM implemented in `mgcv::gamm()` to leverage auto-correlation structures made available through the package `nlme` [@pinheiro2021].
Annual growth was modeled as:


\begin{equation}
g(\Delta r_i) =  f(year_i) + f_j(cambial~age_i)  + c_{i,j} + \tau_{i,k} + e_i 
(\#eq:gam-cambial)
\end{equation}

where $g()$ is a log-link for $\Delta r \sim Gamma$, $\Delta r$ is the annual radial increment for observation $i$. 
A global temporal (by year) and time-dependent ($j$, $\leq 1960$ or $>1960$) trend in cambial age were implemented with thin plate regression splines (default smoothing function in `mgcv`); $c_j$ is a time-group dependent intercept, while $\tau$ represents a matrix of random effect coefficients for $k$ species to account for differences in growth patterns, and $e_i = \phi e_{i−1} + \epsilon_i$.
A $3^{rd}$-order autocorrelation-moving average (ARMA) correlation structure was applied (i.e., $\phi(3,1)$) to account for the dependency of $\Delta r$ across years for each tree, as is frequently the case for tree growth [e.g., see @Fritts1989]; the detailed implementation for this model is given in the code linked to in the supplemental material S1.
$\Delta r$ was then derived for a range of cambial ages, and averaged for both time groups, allowing a comparison of recent to earlier growth.
We acknowledge that tree cores obtained at breast height do not represent absolute tree age.
However, here they serve as a proxy for growth between young ($\gtrapprox 1960$) and older individuals to contextualize growth patterns inferred from the larger-scale tree inventory.


### Stem diameter model development and selection {#sec:methods-gam-heat}

We focused the analyses on the ten most abundant species after data quality control with a minimum of 10000 observations to ensure greatest possible spatial coverage and to increase confidence in estimates, totaling `r drake::readd(n_total_obs)` trees, with Table$~$\@ref(tab:tab-model-samples) showing species-specific sample sizes.


The diameter ($DBH$) of these species was modeled using GAMs as follows:


\begin{equation}
g(DBH_i) = f(x_i,y_i) + f_j(age_i) + f_j(temp_{t,i}, age_i) + f(covariate_i) + c_{i,j} + \tau_{i,k} + \epsilon_i 
(\#eq:gam-full)
\end{equation}


\begin{equation}
g(DBH_i) = f(x_i,y_i) + f_j(age_i) + f_j(temp_{t,i}, age_i) + c_{i,j} + \tau_{i,k} + \epsilon_i
(\#eq:gam-nocovariate)
\end{equation}


\begin{equation}
g(DBH_i) = f(x_i,y_i) + f_j(age_i) +  f(covariate_i) + c_{i,j} + \tau_{i,k} + \epsilon_i 
(\#eq:gam-notemp)
\end{equation}


\begin{equation}
g(DBH_i) = f(x_i,y_i) + f_j(age_i) +  c_{i,j} + \tau_{i,k} + \epsilon_i
(\#eq:gam-age)
\end{equation}


where $g()$ is a log-link for $DBH \sim Gamma$, and $i$, $j$ are indices for observations and species, respectively, and $t$ refers to an (excess) heat measure from UrbClim, Berlin EnvAt or MODIS at different times (morning, afternoon/day, night; see Section [Temperature/UHI data](#sec:tempdata); $c$ is a species-dependent intercept, while $\tau$ represents a matrix of random effect coefficients for $k$ districts to account for differing management regimes across the city.
A global spatial smooth $f(x_i,y_i)$ (representing projected coordinates in UTM) via a Gaussian process [cf. p. 242 in @wood2017] was included to account for the spatial structure of observations, which reduced auto-correlation of model residuals considerably (see supplemental information).
These were compared to a sub-set of models without a spatial component (cf. Equation$~$\@ref(eq:gam-nocovariate), and Fig.$~$\@ref(fig:fig-model-deviance) but not further discussed there).
We also tested a suite of models without the spatial smooth for comparison.

Furthermore, we implemented the interaction between temperature and age (i.e., $f_j(temp, age)$) as tensor smooths [@wood2006] to account for the different variable scales (i.e., units); all models were also tested without this interaction using a thin plate regression spline smooth for temperature (not shown in equations above).
The functions $f_j$ are for species-specific smooths [i.e., with individual smoothness penalties and functional shapes as detailed by @pedersen2019].
The covariates for planting bed area and soil nutrient availability were log transformed to account for their skewed distribution, improving the estimation of coefficients for their respective basis functions.
Note, that Equation$~$\@ref(eq:gam-age) was considered as the appropriate null model for interpretations, and a model including all covariates and the temperature-age interaction was tested as a saturated model.
Models were implemented with `mgcv::bam()` [@wood2017a;@li2020a] and readers are referred to the detailed implementation in the code linked to in the supplemental material.
Considering all combinations of (excess) heat measures and covariates (with point, as well as 150/300$~m$ extractions), a total of `r nrow(drake::readd(bam_dbh_filtered))` models were applied.
With these models, we derived age and species dependent $DBH$ averages across a temperature measure from predicted values in 5-year age groups starting at 30, 45, 60, 75, 90


Model selection was based on explained deviance (similar to explained variance) and the Aikake's information criteria (AIC).
The best model, considered having the highest explanatory power (highest explained deviance) and simplest structure (lowest AIC), was chosen used for final analyses.
Explained deviance assesses model fit in generalized linear modelling similar to explained variance in ordinary least squares modelling, but relies on a generalized form of residual, i.e., deviance residuals [see @wood2017].
Deviance for the Gamma distribution is calculated as


\begin{equation}
D(y, \hat{\mu}) = 2 \cdot \left\{ \frac{y−\hat{\mu}}{\hat{\mu}}  − log(\frac{y}{\hat{\mu}}) \right\}
(\#eq:gam-deviance)
\end{equation}

where $y$ is the observed and $\hat{\mu}$ the expected value.


As the spatial extent and coverage varied between temperature and ancillary data, more complex models (and specifically those including planting bed area and MODIS temperatures) typically also had fewer total observations.
While this prevented a full comparison with information-based model selection criteria like AIC, the appropriateness of models that differed only in their implementation of the temperature-age interaction (i.e., $f_j(temp_i)$ $vs.$ $f_j(temp_i, age_i)$) could be assessed.
For this reason, the suite of developed models presented above were limited to comparatively simple structures (i.e., few terms, interactions and restricted number of basis functions), reducing the potential for choosing over-fitted models without formal comparison.
AIC is calculated as:

\begin{equation}
AIC= −2log(L) \cdot 2k
(\#eq:aic)
\end{equation}


where $L$ is the maximum likelihood estimate, and $k$ is the number of parameters.
Where any two comparable models had a $| \Delta AIC| > 10$, we considered the model with the lower score more suitable. 
<!-- Future research may focus on collecting additional data (e.g., increasing the coverage on planting bed area) and subsequently deriving species-specific smooths for ancillary environmental covariates. -->
We chose to carry out the analysis in its current form rather than on considerably smaller but comparable sample sizes across models, to identify the strongest relationships in the existing data.
This allowed us to highlight the utility of the approach *per se* and for Berlin in particular.
Lastly, we also report the root mean squared error ($RMSE = \sqrt{\frac{1}{n}  \sum_{i=1}^{n}{(y_i - \hat{y}_i)^2}}$) and mean absolute error ($MAE = \frac{1}{n}|y_i - \hat{y}_i|$) for the final model.





# Results {#sec:results}

## Growth trend dynamics

Recently established annual, incremental growth is on average greater as compared to earlier times (i.e., prior 1960; Fig.$~$\@ref(fig:fig-cambial-effect)).
The contrast is strongest in the first 30 years of cambial development, with clear indication that averages are statistically different up to approximately 22 years (cf. overlap of 95$~\%$confidence intervals).
The predicted trajectories for both periods follow typical ontogenetic patterns, yet differ in shape.
This may be due to inaccurately estimated cambial ages, explaining the largely monotonic decrease for recent growth due to missing the typical (but not always present) initial rise and fall in pith-near stages.
This would inadvertently create a left-shift in Fig.$~$\@ref(fig:fig-cambial-effect) for recent growth.
Assuming that to be the case, the actual difference in average rates would be greater than presented here.


**Fig. \@ref(fig:fig-cambial-effect)**

## Model selection

<!-- * null model high, but for predictive purposes more is better -->
<!-- Models including (excess) heat measures were on average better than those without. -->

The null models containing only age to explain diameter captured a large portion of deviance.
Including additional covariates thus resulted only in comparatively small increases of predictive skill.
The inclusion of temperature (additive structure) and temperature-age interactions improved the predictive skill, with interactions reaching higher explained deviance (i.e., skill).
Models including the MODIS-derived UHI measures performed best on average, where models containing $LCZ6_{\frac{}{150~m}}$ or all covariates (saturated model) did best (Fig.$~$\@ref(fig:fig-model-deviance)), which also holds true for other temperature/UHI measures.
Note that non-temperature models containing planting bed area and $LCZ6_{\frac{}{150~m}}$ alone outperformed several of those including other temperature measures and covariate combinations.
This indicated the importance of both covariates, with $LCZ6_{\frac{}{150~m}}$ also represented in the best-performing model, corroborating its impact on stem diameter development.
As $LCZ6_{\frac{}{300~m}}$ only marginally increased performance compared to the null model (age only), the reference scale for the impact of the urban fabric (i.e., LCZ6) likely has a limit at $<300~m$.
Nutrient availability, similar to $LCZ6_{\frac{}{300~m}}$, also only improved model performance marginally.
Building height, regardless of its reference scale (i.e., $150$ $vs$ $300~m$), as another proxy for urban fabric, showed minimal to no improvement compared to the age-only null model. 

```{r mod-aic, echo=FALSE, cache = TRUE}

mod_lcz6_tensor <- readRDS("./analysis/data/models/stat/filtered/mI_spatial_age_x_temp_by_species_lcz6_reBEZIRK_var-day_2007.Rds")
mod_lcz6_add <- readRDS("./analysis/data/models/stat/filtered/mI_spatial_age_ADD_temp_by_species_lcz6_reBEZIRK_var-day_2007.Rds")


mod_assessment <- rbind(broom::glance(mod_lcz6_add), broom::glance(mod_lcz6_tensor)) %>% 
  cbind(data.frame(mod = c("add", "tensor")))

aic_tens = mod_assessment$AIC[mod_assessment$mod == "tensor"]
aic_add = mod_assessment$AIC[mod_assessment$mod == "add"]

```


Differences in sample sizes between model structures due to covariate and/or temperature data coverage were considerable (e.g., planting bed area $vs.$ soil nutrient models for UrbClim UHI).
Thus, we considered the model with the overall greatest predictive skill and largest sample for further investigations, namely $LCZ6_{\frac{}{150~m}}$ for MODIS derived UHI.
For this variable combination, the model structure with age and temperature interaction also had a lower AIC ($AIC~=~8.95 \cdot 10^5$) compared to the additive one ($AIC~=~8.98 \cdot 10^5$).
<!-- For this variable combination, the model structure with age and temperature interaction also had a lower AIC ($AIC~=~`r format(aic_tens, digits = 3, scientific = TRUE)`$) compared to the additive one ($AIC~=~`r format(aic_add, digits = 3, scientific = TRUE)`$). -->


**Fig. \@ref(fig:fig-model-deviance)**



The final model, comprising a temperature-age interaction, the covariate $LCZ6_{\frac{}{150~m}}$ and MODIS derived UHI following Equation$~$\@ref(eq:gam-full), showed good agreement between predicted and observed $DBH$ for the majority of observations (Fig.$~$\@ref(fig:fig-model-performance); $R^2~=~0.79$) resulting in a fairly low MAE of $6.03~cm$, and a RMSE of $7.7\cdot 10^{-7}$. 
While some prediction errors are large (spread in Fig.$~$\@ref(fig:fig-model-performance)), the predictions are unbiased (see correspondence of 1:1 and least-squares fit in Fig.$~$\@ref(fig:fig-model-performance)).
Thus, we consider using species and age-group averages as appropriate for identifying and discussing relationships between $DBH$ and other covariates.


**Fig.$~$\@ref(fig:fig-model-performance)**


## Urban heat and urban fabric effects on stem growth

Relationships derived via the GAM in Equation$~$\@ref(eq:gam-full) with LCZ6 as covariate show fairly consistent responses across age groups considering trajectories, yet they differ somewhat in shape (Fig.$~$\@ref(fig:fig-heat-effect)) and considerably in absolute magnitude (i.e., slope in Fig.$~$\@ref(fig:fig-temp-sens)).
Generally, younger age groups (30-35) showed increased growth (strongest for *A. hippocastanum*, *T. intermedia*, *T. intermedia* 'Pallida'), or little to no impact (*Acer platanoides*, *Acer pseudoplatanus*), with stronger UHI magnitude.
At older ages, this trajectory gradually shifted toward decreasing stem diameter at higher temperatures, with *T. euchlora*, *A. pseudoplatanus* and *P. acerifolia* having the most negative relationships.
Notably, *Platanus acerifolia* showed an earlier reversal of sensitivity at age group 45-50 as compared to other species. This may be due to the stronger upward curvature towards the estimates' lower temperature limit (see respective panel in Fig.$~$\@ref(fig:fig-heat-effect)).
Although the uncertainty around this edge is comparatively well-constrained, the low number of observations at the end of the continuum does call for caution for further interpretation.

The distribution of individual street trees along the UHI continuum, evident in the density estimates in Fig.$~$\@ref(fig:fig-heat-effect), show that the majority of species investigated here are subjected to intermediate to high UHI levels.
Trees in younger age groups are typically further toward the upper end of this continuum.
Several species - including *A. platanoides*, *A. pseudoplatanus*, *Acer hippocastanum*, *Quercus robur*,  and *Tilia euchlora* - have good coverage across the entire UHI continuum (although skewed toward positive values), which increases the confidence in the observed trajectory shift from young to old.
Contrastingly, the cultivar *Tilia intermedia* 'Palllida' is predominantly distributed along the upper end of the continuum, resulting in greater uncertainty in the estimated relationship across age groups and UHI magnitudes.


**Fig.$~$\@ref(fig:fig-heat-effect)**


**Fig. \@ref(fig:fig-temp-sens)**




The chosen model also highlighted that, on average, trees growing in less urbanized environments (i.e., more open to mid-rise urban land cover; $LCZ6_{\frac{}{150~m}}$) achieve greater diameters (Fig.$~$\@ref(fig:fig-lcz6-effect)).
Note, that planting bed area, similar to $LCZ6_{\frac{}{150~m}}$, was identified as a covariate increasing explained deviance, both in models with and without a temperature measure, and represents an opportunity for further investigation, especially following additional data collection.

**Fig.$~$\@ref(fig:fig-lcz6-effect)**




# Discussion

<!-- 1. Temperature, environmental and urban controls on tree growth   -->
<!-- 	+ Intra specific differences -->
<!-- 	  + management -->
<!-- 	  + root vs. canopy (huber value?) -->
<!-- 	  +  accelerated recent growth -->
<!-- 	  + comparison young vs. old -> increased CO2, perhaps limitation of space for time, -->
<!-- 	     as lower conductance under high CO2 may result in more water savings (check WUE -->
<!-- 	     in old vs. young trees? future direction).[@dusenge2019] [@mccarthy2011] -->
<!-- 	+ Sensitive trees in hot spots -->
<!-- 	+ Temporal dynamics   -->
<!-- 	+ Validity and limitations   -->
<!-- 	[@bussotti2014] -->
<!-- 2. Implications:   -->
<!--   + Policy / planning:   -->
<!--     - tree species -->
<!-- 	  - Increase temporal coverage and accuracy   -->
<!-- 		- which trees to prioritize for measurement campaigns   -->
<!-- 		- Supplement species matrix etc. with these analyses   -->
<!-- 		- *MODIS temp best on average - easily accessible/maintainable as compared to model outputs -->
<!-- * $lcz6_{150}$ vs. $lcz6_{300}$ - scale of impact (further investigation, note in discussion)  -->
<!--         - planting bed area .. more data! -->
<!--   + Open data important, drives innovation -->

## Heat, environmental and urban controls on tree growth  

### Demographic patterns

We showed that initial growth rates ($\lessapprox 30~a$) are greater in  recently established trees, as compared to older ones. 
This pattern was found in annually-resolved incremental growth observations, and corresponds with prior work on urban-rural [e.g., @pretzsch2017;@zhao2016] and intra-urban comparisons [e.g., @dahlhausen2018], where it was attributed to increased temperatures - namely, the UHI effect.
Furthermore, the space-for-time substitution highlighted that recently established, i.e. younger, trees have greater (positive) sensitivity to heat than intermediate age groups, while the oldest trees showed lower average absolute growth (diameters) with increasing heat.
We are not aware of other studies reporting such an age-dependent shift in sensitivity.
<!-- , and by contrast, for example, @pretzsch2017 showed ever increasing basal area increments within the age range investigated here for recent as compared to earlier growth. -->
However, the consistency of this pattern across species provides a satisfactory level of confidence in it, and indeed, @dahlhausen2018 also report a time - and by implication an age-dependent - shift of temperature sensitivity on growth depending on urban development intensity, but do not further distinguish between age groups.
The age-dependent shift may be explained by a combination of physiological and environmental changes over time, and/or may be related to management practices, but we acknowledge that additional analyses is required to disentangle these processes.
For instance, higher temperatures may have benefited physiological processes close to their respective optima in both young and old individuals. 
But, as older trees must support greater leaf area through rooting in similarly small (restricted) soil volumes, water availability and nutrients may become increasingly limiting.
Higher rates of transpiration and photosynthesis, driven through temperature increases, could thus turn detrimental as the ratios between soil volume, root and leaf area change throughout a trees life span and in time.
In addition to this, younger trees are typically more rigorously managed and irrigated [e.g., @koeser2014], which may (further) alter age-dependent temperature sensitivity.
We lack data on demographic differences in management to confirm this, and acknowledge that younger trees here also surpassed their establishment phase, which entails high mortality during the first five years after planting [@harris2017;@hilbert2019] during which the above would not apply



### Intra-specific differences

Generally, the ten investigated species and cultivars showed consistent responses in sign, but differed substantially in magnitude, modulated by age.
*Aesculum hippocastanum* , *Tilia intermedia*, *T. intermedia* 'pallida' and showed greatest absolute growth at high temperatures at younger (30-35) as well as older ages (60-65).
The drought tolerance and performance under high temperatures is well documented for the latter two and features in tree selection frameworks, such as species climate matrices in @roloff2009 and in @brune2016, where several studies investigating (hydro)climatic sensitivity were summarized.
Contrastingly, *Acer pseudoplatanus* showed decreased absolute growth with higher temperatures; this corresponds with their classification as *not very suitable* according to @roloff2009.
*Platanus acerifolia* and *Acer platanoides* are considered *suitable* and *very suitable* (@roloff2009), yet show the greatest decline with temperatures here.
Indeed, several studies reviewed in @brune2016 highlight *A. platanoides* as drought-tolerant.
Such contrasting indications are also reported for *A. pseudoplatanus*, and even report *A. hippocastanum* as only moderately tolerant, despite performing best here. 
These differences may be due to idiosyncrasies of planting sites, such as low soil volume and increased potential for water stress, (long-term) interactions with pathogens and herbivores [e.g., @meineke2018], or perhaps related to data quality.
Most important, these differences highlight the need for assessments of performance (e.g., as growth) under location-specific conditions, and this study provides a first attempt and insights into temperature sensitivity at the scale of an entire metropolis.


		
## Utility, transferability and limitations of approach

The major strength of this work is the estimation of growth sensitivity of urban trees to heat and other urban conditions at city-scale with little data and processing power requirements. 
In particular,  differences within and between species across several dimensions (depending on model specification) are readily explored where only tree locations, age, diameter (or any other target) and selected variables are needed to implement this approach.
Indeed, due to the high temporal and spatial variability of controls on growth, and thus variability in responses, such assessments should be developed specifically for a given setting, as well-understood tree characteristics [e.g., @roloff2009], could be strongly mediated at a given location or time. For instance, if drought hardiness is related to extensive root networks, the limited soil volumes available to street trees could render a species vulnerable to water stress. In addition, studies on climatic suitability and physiological responses are difficult to compare due to local acclimation of species to controls on growth and performance, as well as different methodological protocols [e.g., see @brune2016].
Thus, the approach followed here, with its comparatively simple data requirements, can be implemented in a variety of settings to gain initial and/or guiding insights on tree performance in a specific urban region, and also serve as a benchmark to compare other empirical estimates or mechanistic models with.
It may even allow estimating tree performance under future conditions to some extent (e.g., considering increase in temperature alone for this study), but is of course contingent on data coverage (e.g., demographics, environmental gradients).
Furthermore, the implementation of GAM models here with `mgcv::bam()` is computationally efficient [@wood2017a], making model testing, selection and final application a rapid process even for abundant observations (here $n >150000$ and processing times of $t < 60~s$ on a desktop computer for the selected model).
Future research may focus on collecting additional data (e.g., increasing the coverage on planting bed area) and subsequently deriving species-specific smooths for ancillary environmental covariates.

Two noteworthy caveats of the approach followed here lie in its empirical, data-driven nature, and its dependence on data quality.
The presented results here are correlative. 
While their interpretation follows first principles and may also allow anticipating the performance of a given tree under a range of increased temperatures, insights derived from mechanistic understanding are indispensable.
This is because a change in one environmental condition, e.g., temperature or pest abundance, may also entail alterations to other drivers, and ultimately, affect physiological processes in ways not yet captured in existing data.
Furthermore, the data provided in Berlin's tree inventory required extensive quality controlling, and it is likely that inaccurate (diameter, age) or interpolated (diameter) observations were including in the analyses.
However, the minimum requirement of 10000 observations per species, and the focus on average diameter responses across age groups decreased potential impacts of such observations to a degree that was considered satisfactory, while uncertainty is communicated effectively and transparently (i.e., larger confidence bands for *T. intermedia 'Pallida'*).
Further, the utility and transferability of the approach  *per se* were considered of value to the community and practitioners.


## Implications 

<!-- ### Tree selection -->

Tree species selection for urban forests and urban greening depends on several often competing factors -  such as aesthetic appeal and ecosystem service provision [e.g., @roman2020] - and has been focused on identifying trees suitable for current and future conditions for the last decades with increasingly strong evidence basis [e.g., @hirons2019]. 
Here, biogeographical approaches aim to match natural (i.e., non-urban) species distributions within current bioclimatic envelopes with future conditions at a planting site [e.g., @broadmeadow2005].
@watkins2020 used such "climate matching" to identify the space along environmental dimensions (heat, precipitation) which urban regions inhabit, falling within or extending the natural envelope. 
Our work extends this approach by identifying the heat space (i.e., UHI range) occupied by several key species within a city.
This not only allows identifying species-specific and intra-specific (age-dependent) sensitivities to urban conditions, but can also inform how age cohorts may respond as temperatures at a given location shift along the present continuum through time, while accounting for the impacts of additional urban conditions (e.g., management, disturbance, urban fabric).
Notably, increased growth rates at higher temperatures, as reported here, also entail greater demographic turnover through mortality [@smith2019].
<!-- young age groups for most species showed greater absolute growth with higher temperatures, . -->
<!-- Indeed, growing season temperatures in the Berlin region are predicted to rise for the remainder of this century. -->
Thus, as the majority of individuals were situated at the upper end of the temperature continuum, high temperature sensitivity may entail additional management due to faster turn-over and potentially subsequent replacement by more appropriate species.
In addition, our approaach can allow managers and planners to identify potential scale-limits of the urban fabric (e.g., $LCZ6_{\frac{}{150~m}}~vs.~LCZ6_{\frac{}{300~m}}$) on tree performance when altering surroundings or planting in a given area; efforts should be directed toward identifying the most pertinent environmental covariates and how their influence scales in space.
<!-- - ultimately, this will be a trade-off between tolerance of urban conditions, management goals (e.g., ecosystem services) and longevity. -->
<!-- Assessments such as ours here may further aid in selecting appropriate species to achieve these goals. -->
The insights derived from this study, and potentially others following this approach in the future, can therefore add another dimension to tree selection approaches implemented down to individual trees and locations.
It thus complements quantitative and qualitative tools, such as the climate matching tool, ecological site classification or species-climate matrix [see @hirons2019; @roloff2009; @brune2016; and references therein].


<!--  ### Green infrastructure management, planning and open data --> 

<!-- The availability and quality of green infrastructure data, such as street tree inventories, and environmental covariates, determine the confidence in any inference of infrastructure performance in relation to its context (e.g., temperature, planting bed area).  -->
<!-- This is fundamental to inform management and planning to ensure that current and future targets are met.  -->
<!-- Indeed, the execution of this study was possible due to the readily accessible and rich data sources provided by Berlin’s senate. -->
<!-- However, few additions or alterations to data collection and provision schemes would have greatly  enhanced the utility and applicability of the data sets applied here.  -->
<!-- We acknowledge the financial and logistic constraints that authorities are subject to, yet the suggestions below are likely valuable for this and other urban green infrastructure initiatives, as several of them are easily implemented. -->

<!-- Urban tree databases may only represent a single point in time (e.g., see https://opentrees.org), despite repeated inventories at regular and/or irregular intervals within cities or their districts. -->
<!-- However, storing and providing multi-temporal inventories, rather than over-writing existing records, would give planners and researchers a wealth of additional information on individual tree performance, which – even at low temporal coverage – would increase confidence in space-for-time substitutions, or make them superfluous.  -->
<!-- In this regard, it is recommended to enhance and standardize (meta) data collection and provisioning to facilitate data quality control, thereby increasing confidence in the data, and enabling synthesis studies across districts and cities [@ossola2020].  -->
<!-- Key information should include (1) location, absolute age and planting date, (2) management regimes (e.g., planting regime, crown pruning, irrigation), (3) data collection protocol and body (e.g., actual measurement $vs.$ estimate or interpolation), as well as (4) tree provenance to account for potential differences in ecotype and/or acclimation [@watkins2020]. -->
<!-- However, there are financial and logistic trade-offs for data collection of the above, with contrasting needs across stakeholder groups [e.g., academics and authorities, @ostberg2013] where data that supports meeting long-term objectives should be prioritized. -->
<!-- Less abundant species which are candidates for future plantings could be assessed with higher-quality standards regarding the above, to build a more reliable data source even at potentially lower coverage demographically and spatially. -->


Finally, open data was key for this study.
We expressedly urge authorities to implement FAIR (findable, accessible, inter-operable and reusable) data principles to enable work similar to ours, as well as the creation of larger-scale, multi-temporal databases and/or execution of synoptic studies [e.g., @ossola2020].
This also includes the collection and provision of standardized (meta) data for quality control and to improve statistical inference.




# Conclusion

We showcased the application of a GAM-driven analyses to identify the sensitivity of urban tree growth to environmental and urban drivers in a space-for-time framework. 
The extensive data coverage (tree inventory and covariates) allowed us to account for location-specific influences and identify the factors with strongest impacts on growth potentials (i.e., maximum diameter) for individual species.
The identified age-dependent shift of temperature sensitivity, which was fairly consistent across species, as well as inter-specific differences thereof, will inform and guide further research. 
Notably, increasing the confidence in and coverage of data collection on less abundant species is key to maximize the potential of the approach developed here.
<!-- Lastly, together with recommendations for tree selection and infrastructure management, we hope to contribute to the design of best-practices for adaptation and mitigation using street trees with the flexible yet simple analyses approach (regarding data requirements) taken here. -->
Our results are a contribution toward Berlin's current and future management of its tree stock and may help drive adaptation to climate change.
Despite being a case study for a single city, we believe our work may provide a flexible approach for other cities with available or growing inventories, as well as ancillary environmental data, and may also inform the use of other planning tools, such as species-climate matrices [@roloff2009] regarding temperature sensitivity. 

<!-- - novel application of open data to infer sensitivity to urban heat and other pertinent environmental driver -->
<!-- - identified age-shift and most tolerant species -->
<!-- - provide policy-relevant suggestions for authorities and practicioners -->
<!-- - open several avenues for further inquiry: -->
<!--   + multi-temporal -->
<!--   + increase covariate coverage to see if predictable performance alteration (planting bed!) -->
<!--   + less abundant species --> 
<!-- potential to identify suitable trees in a specific urban context (e.g., bespoke for Berlin) -->

# Acknowledgements

AGH and IH were supported through the Helmholtz-Climate-Initiative (HI-CAM), funded by the Helmholtz Initiative and Networking Fund; the authors are responsible for the content of this publication.
We thank Prof Dr Christoph Schneider for providing dendrochronological data and pertinent discussion on its use, as well as Berlin's senate for providing FAIR data and support for its use.

# Supplementary material

**File S1**: html document outlining 1) code and reproducibility for this study, 2) data quality control, and 3) handling of spatial autocorrelation.

<!-- <!-- The following line inserts a page break  --> 
`r pgbreak()`

# References 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>


`r pgbreak()`

# Figures

## Legends



**Fig. \@ref(fig:fig-study-area)** Berlin's generalized land-use derived from @suvkberlin2019 and location within the European context (inset).


**Fig. \@ref(fig:fig-temp-overview)** Overview of data sets used for assessing the relationship between temperature and tree growth, with data sources in rows and averaged time intervals in columns. Note the varying spatial coverage and resolution as noted in Table \@ref(tab:tab-dsources).



**Fig. \@ref(fig:fig-cambial-effect)** Rates for annual incremental growth differ between recent and earlier times, as predicted by a hierarchical GAM (see Section [Dendrochronological analyses](#sec:methods-dendro). Thick lines and bands are for mean and 95$~\%$ confidence interval of all annual predictions across a time group (fine lines). On average, early stages of recent growth (up to approximately 22 years) exceed that of earlier periods discernibly. 


**Fig. \@ref(fig:fig-model-deviance)** Overview of model fit, expressed as explained deviance, for all tested models. The Panels distinguish between models without (top) and with (bottom) spatial smooths to account for autocorrelated residuals. Colored areas reflect (inclusion of) temperature and (excess) heat measures. Symbols identify models with an interaction between temperature and age (diamond), and without (circle), while symbol colors highlight  covariates and their reference radius (i.e. 150/300$~m$, but also note x-axis labels). Symbol size indicates the model's included observations (i.e., sample size). Generally, including temperature (interactions) improve model fits above the null model (age only) and other non-temperature models. However, note the importance ofplanting bed area and LCZ6 cover is apparent even without including temperature. The MODIS-derived UHI measures provide the best fit on average, with the model including a temperature-age interaction and LCZ6 cover scoring highest overall. 

**Fig. \@ref(fig:fig-model-performance)** Predicted $vs.$ observed data for the best model according to explained deviance and AIC comparison, based on the MODIS-derived UHI measure [@chakraborty2019] for average summer conditions (2007) and LCZ6 [open to mid-rise,  @stewart2012]. Hexagons and colors represent x-y bins (i.e., in the observed-predicted space) and their counts (N), and the red line is a least-squares fit.  The model captures the mean response well, as indicated by lighter colors along the dashed 1:1 line, and its close approximation by the least squares fit, as well as model metrics (see text label in figure).


**Fig. \@ref(fig:fig-heat-effect)** Age-group averaged relationships between the MODIS-derived UHI and stem diameter for the ten most abundant species from the best model (i.e., Equation$~$\@ref(eq:gam-full) with LCZ6 as covariate). Note that estimates were derived with $LCZ6_{\frac{}{150~m}} = 0.5$, and that y-axis scales differ between panel rows. The colored lines and bands are the averaged GAM fit, and gray lines are least-squares estimates fitted to these averages. Estimates were only generated within temperature ranges that a given species experienced. Density plots (scaled to match 100$~cm$ on the y-axis) show the distribution of individual trees along the urban heat continuum, aiding both with interpreting uncertainties (band width, "wiggliness") and assessing species' exposure to urban heat. A general shift from increased or stable growth with temperature at younger ages to a decrease for older trees is apparent.



**Fig. \@ref(fig:fig-temp-sens)** Temperature sensitivity of diameter growth centered on species-specific means for comparability and to aid interpretation of inter-specific differences. Lines and bands are from ordinary least squares fits on the GAM estimates in Fig.$~$\@ref(fig:fig-heat-effect) (A) and the corresponding coefficients (slopes, B). 


**Fig. \@ref(fig:fig-lcz6-effect)** Age-group averaged relationships between the LCZ6 and stem diameter for two $Tilia$ genera from the best model (i.e., Equation$~$\@ref(eq:gam-full) with MODIS-derived UHI as excess heat measure). LCZ6 cover was derived as a weighted average within a radius of 150$~m$ around each tree. Note the identical shape, but difference in intercept as a result of the model specification with a global smooth the non-temperature covariate for all species (see Section [Stem diameter model development and selection](#sec:methods-gam-heat); the UHI magnitude was fixed at $3^\circ C$ where most trees are present across age groups. The model identified a steady increase of average stem diameter with open to mid-rise urban land cover. 



`r pgbreak()`

## Visualization


```{r fig-study-area, fig.cap = "PLACEHOLDER", fig.width = 12, fig.height = 14, out.width="50%"}




knitr::include_graphics(here::here("analysis/figures/map_00_studyarea.png"))
```


```{r fig-temp-overview, fig.cap="PLACEHOLDER",fig.width = 12, fig.height = 12, out.width="100%"}




knitr::include_graphics(here::here("./analysis/figures/fig_temp_maps.png"))
```


```{r fig-cambial-effect, fig.cap="PLACEHOLDER", out.width="50%", include=TRUE, eval=TRUE}


knitr::include_graphics(here::here("analysis/figures/fig-biwi-growth.png"))

```



```{r fig-model-deviance, fig.cap="PLACEHOLDER", out.width="100%", include=TRUE, eval=TRUE}


knitr::include_graphics(here::here("analysis/figures/fig_model_deviance.png"))

```


```{r fig-model-performance, fig.cap="PLACEHOLDER", out.width="50%", include=TRUE, eval=TRUE}


knitr::include_graphics(here::here("analysis/figures/fig-gam-dbh_temp-day2007_lcz6_obs_pred.png"))

```


```{r fig-heat-effect, fig.cap="PLACEHOLDER", out.width="100%", include=TRUE, eval=TRUE}


knitr::include_graphics(here::here("analysis/figures/fig-gam-dbh_temp-day2007_lcz6.png"))

```


```{r fig-temp-sens, fig.cap="PLACEHOLDER", out.width="100%", include=TRUE, eval=TRUE}


knitr::include_graphics(here::here("analysis/figures/fig_model_day2007_lcz6_growthsens.png"))

```



```{r fig-lcz6-effect, fig.cap="PLACEHOLDER", out.width="50%", include=TRUE, eval=TRUE}


knitr::include_graphics(here::here("analysis/figures/fig-gam-dbh_temp-day2007_xvar-lcz6_tilia.png"))

```



`r pgbreak()`


# Tables

```{r dsources-prep, include=FALSE}

options(knitr.kable.NA = "")


dsources_path <- "analysis/data/tables/data_sources.xlsx"
dsources <- readxl::read_excel(dsources_path, na = "NA")
dsources$Accessed <- format(dsources$Accessed, "%b '%y")

```

```{r tab-dsources, eval = TRUE}

caption <- "Data description used for maps/visualizations and analyses. Resolution and radius are in $m$, the latter is the buffer in which data was averaged around each tree. A zero-radius refers to a point extraction from categorical and location specific data. Polygons with radius data were rasterized to a resolution of $5~m$"
caption_ov_short <- "Data descriptions"

dsource <- dsources[-which(dsources$File == 'Wintertime_gridded_UHI_data.zip'), ]


dsources <- dsources %>%
    dplyr::mutate(Category = forcats::fct_relevel(Category, 'trees', 'temperature', 'landuse', 'ancillary', 'gov')) %>% 
    arrange(Category) %>%
  dplyr::select(Name = `Name-eng`, Accessed, Type, Unit = `Unit-latex`, Resolution, Radius, Source = `Source-short`, Reference = TextRef) %>%
  # dplyr::filter(Name != "UHI Berlin",
  dplyr::filter(Name != "Park Trees",
                Name != "Riparian Trees") 


if (grepl("docx", out_format)) {
    table_ds <- dsources %>% 
        knitr::kable(booktabs = TRUE,
                     
                     caption = caption,
                     caption.short = caption,
                     format = "pipe",
                     # col.names = c("Subject/Relevance",
                     #              "Desc.",
                     #              "Type",
                     #              "Obsv. (n)",
                     #              "Resolution (m)",
                     #              "Source")
                     escape = FALSE) %>% 
        kableExtra::landscape()
} else if(knitr::is_latex_output() ){
    table_ds <- dsources %>% 
        knitr::kable(booktabs = TRUE,
                     
                     caption = caption,
                     caption.short = caption,
                     format = "latex",
                     # col.names = c("Subject/Relevance",
                     #              "Desc.",
                     #              "Type",
                     #              "Obsv. (n)",
                     #              "Resolution (m)",
                     #              "Source")
                     escape = FALSE) %>% 
        kableExtra::landscape()
    
} else {
    table_ds <- dsources %>% 
        knitr::kable(booktabs = TRUE,
                     format = "html",
                     
                     caption = caption,
                     caption.short = caption_ov_short,
                     # col.names = c("Subject/Relevance",
                     #              "Desc.",
                     #              "Type",
                     #              "Obsv. (n)",
                     #              "Resolution (m)",
                     #              "Source")
                     escape = FALSE) 
}


table_ds %>% 
  kableExtra::kable_styling(full_width = TRUE, 
                            font_size = 11,
                            latex_options = c("hold_position")) %>% 
  kableExtra::row_spec(0, bold = TRUE, font_size = 12) 


# dsources %>%
#   
#   knitr::kable(caption = caption, escape = FALSE) %>%
#   kableExtra::kable_styling(full_width = TRUE,
#                             bootstrap_options = c("striped", "hover", "condensed", "responsive"))


# flextable::set_flextable_defaults(padding.left = 0)
# 
# dsources %>%
#   dplyr::select(`Name-eng`, Accessed, Type, Source, TextRef) %>%
#   flextable::flextable() %>%
#   flextable::autofit()


```


```{r tab-age}

drake::loadd(age_tables)

age_tables <- age_tables %>% 
  dplyr::arrange(desc(n_total))
colnames(age_tables)[c(1,7,8, 9)] <- c("Genera", "150+", "Total (n)", "Missing (n)") 

age_tables <- dplyr::bind_rows(age_tables[age_tables$Genera!="Other",],
                        age_tables[age_tables$Genera=="Other",])

  
add_row <- as.data.frame(matrix(c(NA, colSums(age_tables[,-1])), nrow = 1))
add_row[1,1] <- "Marg. Totals"
colnames(add_row) <- colnames(age_tables)

age_tables <- dplyr::bind_rows(age_tables,
                    add_row)


caption_trees <- "Binned age-distribution for street tree genera in Berlin data set, and entries missing age information. "
caption_trees_short <- "Binned age-distribution for genera in Berlin data set."

if (grepl("docx", out_format)) {
    table_dat_req_kable <- age_tables %>% 
        knitr::kable(booktabs = TRUE,
                     format = "pipe",
                     caption = caption_trees,
                     caption.short = caption_trees_short
        ) %>% 
        kableExtra::row_spec(13, hline_after = TRUE) 
} else if(knitr::is_latex_output() ){
    table_dat_req_kable <- age_tables %>% 
        knitr::kable(booktabs = TRUE,
                     format = "latex",
                     caption = caption_trees,
                     caption.short = caption_trees_short
        ) %>% 
        kableExtra::row_spec(13, hline_after = TRUE) 
    
} else {
    table_dat_req_kable <- age_tables %>% 
        knitr::kable(booktabs = TRUE,
                     format = "html",
                     caption = caption_trees,
                     caption.short = caption_trees_short
        ) %>% 
        kableExtra::row_spec(13, extra_css = "border-bottom: 1px solid")
    
    # %>% 
#   kableExtra::kable_styling(full_width = TRUE, 
#                             font_size = 10) %>% 
#   kableExtra::column_spec(1, italic = TRUE) %>%
#   kableExtra::row_spec(0, bold = TRUE) %>% 
#     kableExtra::row_spec(13, hline_after = TRUE) 

}


   table_dat_req_kable %>% 
  kableExtra::kable_styling(full_width = TRUE, 
                            font_size = 11) %>% 
  kableExtra::column_spec(1, italic = TRUE) %>%  
  kableExtra::row_spec(0, italic = FALSE, bold = TRUE, font_size = 12) 

```




```{r tab-dendro-sites}

drake::loadd(series_long)
drake::loadd(species_lookup)

sampling_site_overview <-     series_long %>% 
        dplyr::filter(grepl("urban", x = site_type)) %>% 
        dplyr::select(sample_location, species, tree_id) %>% 
        dplyr::group_by(sample_location, species) %>%
        dplyr::summarize(tree_id = unique(tree_id)) %>% 
        # mutate(site_type = gsub("[-].*$", "", site_type)) %>% 
        dplyr::tally() %>% 
    dplyr::mutate(sample_location = stringr::str_replace(sample_location, "[-][a-zA-Zä]+$", "") %>% 
               stringr::str_replace(pattern = "-StEi", ""))


spec_matched <- species_lookup$Species[match(sampling_site_overview$species, species_lookup$Code)]

sampling_site_overview$species_long <- spec_matched

sampling_site_overview <- sampling_site_overview %>% 
    dplyr::select(Location = sample_location, Species = species_long, n)



caption <- "Overview of urban sampling locations and species sample sizes (n). Individual trees were sampled two or tree times to obtain a mean-tree ring width series."
caption_ov_short <- caption


if (grepl("docx", out_format) ){
  table_ds <- sampling_site_overview %>% 
  knitr::kable(booktabs = TRUE,
              
             caption = caption,
             caption.short = caption,
             format = "pipe",
             escape = FALSE) 
} else if (knitr::is_latex_output() ) {
  table_ds <- sampling_site_overview %>% 
  knitr::kable(booktabs = TRUE,
              
             caption = caption,
             caption.short = caption,
             format = "latex",
             # col.names = c("Subject/Relevance",
             #              "Desc.",
             #              "Type",
             #              "Obsv. (n)",
             #              "Resolution (m)",
             #              "Source")
             escape = FALSE) 
  
} else {
table_ds <- sampling_site_overview %>% 
  knitr::kable(booktabs = TRUE,
               format = "html",
               
             caption = caption,
             caption.short = caption_ov_short,
             # col.names = c("Subject/Relevance",
             #              "Desc.",
             #              "Type",
             #              "Obsv. (n)",
             #              "Resolution (m)",
             #              "Source")
             escape = FALSE) 
}


table_ds %>% 
  kableExtra::kable_styling(full_width = TRUE, 
                            font_size = 11,
                            latex_options = c("hold_position")) %>% 
  kableExtra::row_spec(0, bold = TRUE, font_size = 12) 




    

```






```{r tab-model-samples}

drake::loadd(n_total_species_obs)


caption <- "Ten Most abundant species and total sample size (n) for which GAM models were developed. Note that ancillary data availability across variables determined final sample sizes in individual models."
caption_ov_short <- caption


if (grepl("docx", out_format) ){
  table_ds <- n_total_species_obs %>% 
  knitr::kable(booktabs = TRUE,
              
             caption = caption,
             caption.short = caption,
             format = "pipe",
             escape = FALSE) 
} else if (knitr::is_latex_output() ) {
  table_ds <- n_total_species_obs %>% 
  knitr::kable(booktabs = TRUE,
              
             caption = caption,
             caption.short = caption,
             format = "latex",
             # col.names = c("Subject/Relevance",
             #              "Desc.",
             #              "Type",
             #              "Obsv. (n)",
             #              "Resolution (m)",
             #              "Source")
             escape = FALSE) 
  
} else {
table_ds <- n_total_species_obs %>% 
  knitr::kable(booktabs = TRUE,
               format = "html",
               
             caption = caption,
             caption.short = caption_ov_short,
             # col.names = c("Subject/Relevance",
             #              "Desc.",
             #              "Type",
             #              "Obsv. (n)",
             #              "Resolution (m)",
             #              "Source")
             escape = FALSE) 
}


table_ds %>% 
  kableExtra::kable_styling(full_width = TRUE, 
                            font_size = 11,
                            latex_options = c("hold_position")) %>% 
  kableExtra::row_spec(0, bold = TRUE, font_size = 12) 




    

```


